import{d as n}from"./vendor-CbvXNS-i.js";import{a as r}from"./index--w8yyAH4.js";import"./ui-D_DTyfBr.js";const i="/admin-api",u=n("adminAuth",{state:()=>({user:null,token:null,permissions:[],isAuthenticated:!1,loading:!1,error:null,refreshInterceptor:null,responseInterceptor:null}),getters:{isAdmin:e=>e.isAuthenticated&&e.user?.role!=="viewer",isSuperAdmin:e=>e.user?.role==="super_admin",canManageUsers:e=>e.hasPermission("manage_users"),canManageSettings:e=>e.hasPermission("manage_settings"),canManageDeliveries:e=>e.hasPermission("manage_deliveries"),canViewReports:e=>e.hasPermission("view_reports")},actions:{async login(e){this.loading=!0,this.error=null;try{const s=await r.post(`${i}/api/login/`,e),{access:t,refresh:o}=s.data;return this.token=t,this.isAuthenticated=!0,localStorage.setItem("admin_access_token",t),localStorage.setItem("admin_refresh_token",o),this.setupAxios(),await this.fetchUserProfile(),{success:!0}}catch(s){throw this.error=s.response?.data?.message||"Login failed",this.isAuthenticated=!1,this.token=null,s}finally{this.loading=!1}},async logout(){try{this.user=null,this.token=null,this.permissions=[],this.isAuthenticated=!1,localStorage.removeItem("admin_access_token"),localStorage.removeItem("admin_refresh_token"),delete r.defaults.headers.common.Authorization}catch(e){console.error("Logout error:",e)}},async fetchUserProfile(){try{const e=await r.get(`${i}/api/users/me/`);this.user=e.data,this.permissions=this.extractPermissions(e.data)}catch(e){throw console.error("Failed to fetch user profile:",e),e}},async refreshToken(){try{const e=localStorage.getItem("admin_refresh_token");if(!e)throw new Error("No refresh token available");const s=await r.post(`${i}/api/token/refresh/`,{refresh:e}),{access:t}=s.data;return this.token=t,localStorage.setItem("admin_access_token",t),this.setupAxios(),t}catch(e){throw console.error("Token refresh failed:",e),await this.logout(),e}},setupAxios(){this.refreshInterceptor&&r.interceptors.request.eject(this.refreshInterceptor),this.refreshInterceptor=r.interceptors.request.use(e=>{const s=this.token||localStorage.getItem("admin_access_token");return s&&(e.headers.Authorization=`Bearer ${s}`),e},e=>Promise.reject(e)),this.responseInterceptor&&r.interceptors.response.eject(this.responseInterceptor),this.responseInterceptor=r.interceptors.response.use(e=>e,async e=>{const s=e.config;if(e.response?.status===401&&!s._retry){s._retry=!0;try{return await this.refreshToken(),r(s)}catch(t){return await this.logout(),window.location.href="/admin-login",Promise.reject(t)}}return Promise.reject(e)})},extractPermissions(e){const s=[];if(e.role==="super_admin")return["*"];const t={admin:["view_dashboard","manage_customers","manage_drivers","manage_deliveries","manage_packages","view_reports","manage_settings","manage_users"],manager:["view_dashboard","manage_customers","manage_drivers","manage_deliveries","manage_packages","view_reports"],operator:["view_dashboard","manage_customers","manage_deliveries"],viewer:["view_dashboard","view_reports"]};if(s.push(...t[e.role]||[]),e.custom_role?.permissions){const o=e.custom_role.permissions;Object.keys(o).forEach(a=>{o[a]&&s.push(a)})}return[...new Set(s)]},hasPermission(e){return this.isAuthenticated?this.permissions.includes("*")?!0:this.permissions.includes(e):!1},async changePassword(e){try{return await r.post(`${i}/api/users/change-password/`,e),{success:!0}}catch(s){throw new Error(s.response?.data?.message||"Password change failed")}},async updateProfile(e){try{const s=await r.put(`${i}/api/users/${this.user.id}/update_profile/`,e);return this.user={...this.user,...s.data},s.data}catch(s){throw new Error(s.response?.data?.message||"Profile update failed")}},initialize(){try{const e=localStorage.getItem("admin_access_token");e&&(this.token=e,this.isAuthenticated=!0,this.setupAxios(),this.fetchUserProfile().catch(()=>{this.logout()}))}catch(e){console.error("Failed to initialize admin auth store:",e)}},isReady(){return this.user!==null||this.token!==null}}});export{u as useAdminAuthStore};
