<!-- templates/main/customer_portal.html -->
{% extends 'base.html' %}

{% block title %}Customer Portal - PinDrop{% endblock %}

{% block extra_css %}
<style>
.order-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    padding: 1rem;
}

.status-badge {
    font-size: 0.8rem;
}

.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 8px;
    top: 20px;
    bottom: -20px;
    width: 2px;
    background: #dee2e6;
}

.timeline-marker {
    position: absolute;
    left: -12px;
    top: 4px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #007bff;
    border: 2px solid #fff;
}

.modal-lg {
    max-width: 800px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Customer Portal</h2>
                <div>
                    <span class="me-3">Welcome, {{ customer.name }}</span>
                    <a href="{% url 'customer_logout' %}" class="btn btn-outline-danger btn-sm">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Orders</h5>
                    <p class="card-text display-6">{{ stats.total_orders|default:0 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Pending Orders</h5>
                    <p class="card-text display-6">{{ stats.pending_orders|default:0 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Completed Orders</h5>
                    <p class="card-text display-6">{{ stats.completed_orders|default:0 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Total Spent</h5>
                    <p class="card-text display-6">$0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <button class="btn btn-primary me-3" data-bs-toggle="modal" data-bs-target="#createOrderModal">
                <i class="bi bi-plus-circle"></i> Create New Order
            </button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#trackOrderModal">
                <i class="bi bi-search"></i> Track Order
            </button>
        </div>
    </div>

    <!-- Orders List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">My Orders</h5>
                </div>
                <div class="card-body">
                    {% if orders %}
                        {% for order in orders %}
                        <div class="order-card">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Tracking #</strong><br>
                                    <span class="text-primary">{{ order.tracking_number }}</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Package</strong><br>
                                    {{ order.package.description|truncatechars:30 }}
                                </div>
                                <div class="col-md-2">
                                    <strong>Status</strong><br>
                                    <span class="badge status-badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'pending' %}warning{% elif order.status == 'cancelled' %}danger{% else %}primary{% endif %}">
                                        {{ order.status|title }}
                                    </span>
                                </div>
                                <div class="col-md-2">
                                    <strong>Delivery Fee</strong><br>
                                    ${{ order.delivery_fee }}
                                </div>
                                <div class="col-md-2">
                                    <strong>Actions</strong><br>
                                    <button class="btn btn-sm btn-outline-primary" onclick="trackSpecificOrder('{{ order.tracking_number }}')">
                                        Track
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center">
                            <p>No orders found. Create your first order to get started!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createOrderForm">
                    <!-- Package Information -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">Package Information</h6>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="description" class="form-label">Package Description *</label>
                                <textarea class="form-control" id="description" name="description" rows="2" required></textarea>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="weight" class="form-label">Weight (kg) *</label>
                                <input type="number" step="0.1" class="form-control" id="weight" name="weight" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dimensions" class="form-label">Dimensions (LxWxH cm) *</label>
                                <input type="text" class="form-control" id="dimensions" name="dimensions" placeholder="30x20x10" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="package_type" class="form-label">Package Type *</label>
                                <select class="form-control" id="package_type" name="package_type" required>
                                    <option value="">Select Type</option>
                                    <option value="document">Document</option>
                                    <option value="parcel">Parcel</option>
                                    <option value="fragile">Fragile</option>
                                    <option value="perishable">Perishable</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Information -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">Delivery Information</h6>
                        <div class="mb-3">
                            <label for="pickup_address" class="form-label">Pickup Address *</label>
                            <textarea class="form-control" id="pickup_address" name="pickup_address" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="delivery_address" class="form-label">Delivery Address *</label>
                            <textarea class="form-control" id="delivery_address" name="delivery_address" rows="2" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="estimated_pickup" class="form-label">Estimated Pickup *</label>
                                <input type="datetime-local" class="form-control" id="estimated_pickup" name="estimated_pickup" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="estimated_delivery" class="form-label">Estimated Delivery *</label>
                                <input type="datetime-local" class="form-control" id="estimated_delivery" name="estimated_delivery" required>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">Payment Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="payment_method" class="form-label">Payment Method *</label>
                                <select class="form-control" id="payment_method" name="payment_method" required>
                                    <option value="">Select Payment Method</option>
                                    <option value="cash">Cash on Delivery</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="bank">Bank Transfer</option>
                                    <option value="mobile">Mobile Money</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="amount" class="form-label">Amount ($)</label>
                                <input type="number" step="0.01" class="form-control" id="amount" name="amount" readonly>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Estimated Cost:</strong> 
                            Base: $<span id="baseCost">0</span> | 
                            <strong>Total: $<span id="totalCost">0</span></strong>
                        </div>
                    </div>

                    <div id="orderError" class="alert alert-danger" style="display: none;"></div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="createOrderBtn">Create Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Track Order Modal -->
<div class="modal fade" id="trackOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Track Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="trackingNumber" class="form-label">Enter Tracking Number</label>
                    <input type="text" class="form-control" id="trackingNumber" placeholder="e.g., PKG123456789ABC">
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="trackOrder()">Track Order</button>
                </div>
                
                <div id="trackingResults" class="mt-4" style="display: none;">
                    <h6>Order Details</h6>
                    <div id="orderDetails"></div>
                </div>
                
                <div id="trackingError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate cost when weight changes
document.getElementById('weight').addEventListener('input', calculateCost);

function calculateCost() {
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const baseRate = 10; // $10 per kg
    const baseCost = weight * baseRate;
    
    document.getElementById('baseCost').textContent = baseCost.toFixed(2);
    document.getElementById('totalCost').textContent = baseCost.toFixed(2);
    document.getElementById('amount').value = baseCost.toFixed(2);
}

// Create order
document.getElementById('createOrderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        package: {
            description: formData.get('description'),
            weight: parseFloat(formData.get('weight')),
            dimensions: formData.get('dimensions'),
            package_type: formData.get('package_type'),
            value: 0,
            special_instructions: ''
        },
        delivery: {
            pickup_address: formData.get('pickup_address'),
            delivery_address: formData.get('delivery_address'),
            estimated_pickup: formData.get('estimated_pickup'),
            estimated_delivery: formData.get('estimated_delivery'),
            priority: 1
        },
        payment: {
            payment_method: formData.get('payment_method'),
            amount: parseFloat(formData.get('amount'))
        }
    };
    
    const createOrderBtn = document.getElementById('createOrderBtn');
    createOrderBtn.disabled = true;
    createOrderBtn.innerHTML = 'Creating...';
    
    try {
        const response = await fetch('{% url "create_order" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(`Order created successfully! Tracking number: ${result.tracking_number}`);
            window.location.reload();
        } else {
            showOrderError(result.error || 'Failed to create order');
        }
    } catch (error) {
        showOrderError('An error occurred. Please try again.');
    } finally {
        createOrderBtn.disabled = false;
        createOrderBtn.innerHTML = 'Create Order';
    }
});

function showOrderError(message) {
    const errorDiv = document.getElementById('orderError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

// Track order function
async function trackOrder() {
    const trackingNumber = document.getElementById('trackingNumber').value;
    if (!trackingNumber) {
        showTrackingError('Please enter a tracking number');
        return;
    }
    
    try {
        const response = await fetch(`{% url 'track_order' %}?tracking_number=${trackingNumber}`);
        const result = await response.json();
        
        if (response.ok) {
            displayTrackingResults(result);
        } else {
            showTrackingError(result.error || 'Tracking number not found');
        }
    } catch (error) {
        showTrackingError('An error occurred while tracking the order');
    }
}

function trackSpecificOrder(trackingNumber) {
    document.getElementById('trackingNumber').value = trackingNumber;
    const modal = new bootstrap.Modal(document.getElementById('trackOrderModal'));
    modal.show();
    trackOrder();
}

function displayTrackingResults(order) {
    const resultsDiv = document.getElementById('trackingResults');
    const detailsDiv = document.getElementById('orderDetails');
    
    detailsDiv.innerHTML = `
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tracking Number</h6>
                        <p class="h5 text-primary">${order.tracking_number}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <span class="badge bg-${getStatusColor(order.status)} fs-6">
                            ${order.status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Package</h6>
                        <p>${order.package.description}</p>
                        <small class="text-muted">
                            Weight: ${order.package.weight}kg | 
                            Type: ${order.package.package_type}
                        </small>
                    </div>
                    <div class="col-md-6">
                        <h6>Delivery Address</h6>
                        <p>${order.delivery_address}</p>
                        <small class="text-muted">
                            Estimated: ${new Date(order.estimated_delivery).toLocaleDateString()}
                        </small>
                    </div>
                </div>
                ${order.payment ? `
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <strong>Amount:</strong> $${order.payment.amount}
                    </div>
                    <div class="col-md-4">
                        <strong>Method:</strong> ${order.payment.payment_method.toUpperCase()}
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong> 
                        <span class="badge bg-${getPaymentStatusColor(order.payment.status)}">
                            ${order.payment.status.toUpperCase()}
                        </span>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
    document.getElementById('trackingError').style.display = 'none';
}

function showTrackingError(message) {
    const errorDiv = document.getElementById('trackingError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('trackingResults').style.display = 'none';
}

function getStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'assigned': 'info',
        'picked_up': 'primary',
        'in_transit': 'primary',
        'delivered': 'success',
        'failed': 'danger',
        'cancelled': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getPaymentStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'paid': 'success',
        'failed': 'danger',
        'refunded': 'info'
    };
    return colors[status] || 'secondary';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}